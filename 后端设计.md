# 后端设计

该文档为后端设计文档，负责撰写实验报告的同学请参照此文档编写。

## 存储

所有元数据均使用JSON格式存储。

数据库中的每张表由一个文件单独存储，文件名即为表名（附加`.json`扩展名），文件格式为纯文本文件，不限制字符编码。该文件的根对象描述表本身，格式如下：

| 属性     | 类型             | 描述               |
| -------- | ---------------- | ------------------ |
| `name`   | 字符串           | 表的名称[^1]       |
| `desc`   | 字符串           | 表的描述           |
| `fields` | 数组（包含对象） | 表所包含的字段集合 |

上述对象的`feilds`属性中的每一个对象，均描述该表中的一个字段，格式如下：

| 属性          | 类型                     | 描述             |
| ------------- | ------------------------ | ---------------- |
| `name`        | 字符串                   | 字段的名称[^2]   |
| `desc`        | 字符串                   | 字段的描述       |
| `constraints` | 数组（包含字符串或对象） | 字段所包含的约束 |

上述对象的`constraints`属性中的每一个字符串或对象，均描述对该字段的一个约束（字段类型也算作约束的一种[^3]）。若为字符串，则该字符串为约束名；若为对象，则格式如下：

| 属性   | 类型                                   | 描述       |
| ------ | -------------------------------------- | ---------- |
| `type` | 字符串                                 | 约束的名称 |
| `args` | 对象（非空，且属性的值不是数组或对象） | 约束的参数 |

下面列出已经实现的或计划实现的约束：

- [ ] `INTEGER`: 整数类型；
- [ ] `REAL`: 浮点数类型；
- [ ] `CHAR`: 定长字符串类型；拥有一个参数`len`，为整数，表示最多存储的字符数量；
- [ ] `TEXT`: 不定长字符串类型；
- [ ] `PRIMARY_KEY`: 主键约束，一张表中有且仅有一个，必须与`NOT_NULL`和`UNIQUE`共存；
- [ ] `AUTO_INCREMENT`: 表示该字段的值动态递增，必须与`INTEGER`共存。
- [ ] `NOT_NULL`: 非空约束；
- [ ] `UNIQUE`: 表示该字段的值必须各不相同的约束；
- [ ] `FOREIGN_KEY`: 外键约束；拥有一个参数`table`，为字符串，表示主表的表名；

例如，下面的SQL语句所创建的表将会被存储如下形式[^4]：

```sql
CREATE TABLE student (
    uuid INTEGER AUTO_INCREMENT PRIMARY KEY,
    name CHAR(32) NOT NULL,
    stid CHAR(16) NOT NULL UNIQUE,
    cnid CHAR(18) NOT NULL UNIQUE
);
```

```json
{
    "name": "student",
    "desc": "学生数据表",
    "fields": [
        {
            "name": "uuid",
            "desc": "统一身份认证号",
            "constraints": ["INTEGER", "AUTO_INCREMENT", "NOT_NULL", "UNIQUE", "PRIMARY_KEY"]
        },
        {
            "name": "name",
            "desc": "姓名",
            "constraints": [{"type": "CHAR", args: {"len": 32}}, "NOT_NULL"]
        },
        {
            "name": "stid",
            "desc": "学生证号码",
            "constraints": [{"type": "CHAR", args: {"len": 16}}, "NOT_NULL", "UNIQUE"]
        },
        {
            "name": "cnid",
            "desc": "身份证号码",
            "constraints": [{"type": "CHAR", args: {"len": 18}}, "NOT_NULL", "UNIQUE"]
        }
    ]
}
```

[^1]: 该属性的值会与文件名做校验，若不相等则认为文件损坏。
[^2]: 该属性的值必须在整张表内唯一。
[^3]: 因此，每个字段必须有且仅有一种类型约束。
[^4]: SQL语句无法添加表或字段描述。

## 接口

该部分描述系统后端暴露给系统前端的接口。

## 实现

该部分描述系统后端的内部架构。

